// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                    String   @id @default(cuid())
  auth0Id               String   @unique
  email                 String   @unique
  firstName             String
  lastName              String
  phone                 String?
  profileImage          String?
  role                  UserRole @default(CUSTOMER)
  status                UserStatus @default(ACTIVE)
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
  deletedAt             DateTime?

  shipments             Shipment[]
  addresses             Address[]
  paymentMethods        PaymentMethod[]
  notifications         Notification[]
  trackingSubscriptions TrackingSubscription[]

  @@index([auth0Id])
  @@index([role])
  @@index([status])
}

model Driver {
  id                    String   @id @default(cuid())
  auth0Id               String   @unique
  email                 String   @unique
  firstName             String
  lastName              String
  phone                 String   @unique
  licenseNumber         String   @unique
  licenseExpiry         DateTime
  vehicleNumber         String
  vehicleType           String
  status                DriverStatus @default(ACTIVE)
  currentLatitude       Float?
  currentLongitude      Float?
  lastLocationUpdate    DateTime?
  totalDeliveries       Int      @default(0)
  rating                Float    @default(5.0)
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  assignedShipments     ShipmentAssignment[]
  locationHistory       DriverLocation[]
  notifications         DriverNotification[]

  @@index([status])
  @@index([email])
}

model Shipment {
  id                    String   @id @default(cuid())
  trackingNumber        String   @unique
  userId                String
  user                  User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  senderName            String
  senderEmail           String
  senderPhone           String
  senderAddress         String
  senderCity            String
  senderCountry         String
  senderPostalCode      String
  senderLatitude        Float
  senderLongitude       Float

  recipientName         String
  recipientEmail        String
  recipientPhone        String
  recipientAddress      String
  recipientCity         String
  recipientCountry      String
  recipientPostalCode   String
  recipientLatitude     Float
  recipientLongitude    Float

  packageType           PackageType
  weight                Float
  length                Float
  width                 Float
  height                Float
  description           String
  value                 Float
  currency              String @default("USD")
  
  serviceType           ServiceType
  transportMode         TransportMode @default(LAND)
  status                ShipmentStatus @default(PENDING)
  
  shippingCost          Float
  insuranceCost         Float?
  totalCost             Float
  
  estimatedDeliveryDate DateTime?
  actualDeliveryDate    DateTime?
  deliverySignature     String?
  deliveryPhoto         String?

  customsStatus         CustomsStatus?
  customsDocuments      String[]
  
  notes                 String?
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
  deletedAt             DateTime?

  trackingEvents        TrackingEvent[]
  assignments           ShipmentAssignment[]
  documents             ShipmentDocument[]
  issues                ShipmentIssue[]
  refundRequest         RefundRequest?
  payment               Payment?
  notifications         Notification[]
  subscriptions         TrackingSubscription[]

  @@index([userId])
  @@index([status])
  @@index([trackingNumber])
  @@index([createdAt])
}

model ShipmentAssignment {
  id                    String   @id @default(cuid())
  shipmentId            String
  shipment              Shipment @relation(fields: [shipmentId], references: [id], onDelete: Cascade)
  driverId              String
  driver                Driver   @relation(fields: [driverId], references: [id])
  
  assignedAt            DateTime @default(now())
  completedAt           DateTime?
  
  @@unique([shipmentId, driverId])
  @@index([driverId])
}

model TrackingEvent {
  id                    String   @id @default(cuid())
  shipmentId            String
  shipment              Shipment @relation(fields: [shipmentId], references: [id], onDelete: Cascade)
  
  status                ShipmentStatus
  location              String
  city                  String
  country               String
  latitude              Float?
  longitude             Float?
  facility              String?
  description           String
  transportMode         TransportMode?
  notes                 String?
  updatedBy             String
  
  createdAt             DateTime @default(now())

  @@index([shipmentId])
  @@index([status])
}

model DriverLocation {
  id                    String   @id @default(cuid())
  driverId              String
  driver                Driver   @relation(fields: [driverId], references: [id], onDelete: Cascade)
  
  latitude              Float
  longitude             Float
  accuracy              Float?
  altitude              Float?
  
  createdAt             DateTime @default(now())

  @@index([driverId])
  @@index([createdAt])
}

model Address {
  id                    String   @id @default(cuid())
  userId                String
  user                  User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  type                  AddressType
  label                 String
  address               String
  city                  String
  country               String
  postalCode            String
  latitude              Float
  longitude             Float
  
  isDefault             Boolean  @default(false)
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  @@index([userId])
}

model PaymentMethod {
  id                    String   @id @default(cuid())
  userId                String
  user                  User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  type                  PaymentType
  cardLast4             String?
  cardBrand             String?
  expiryMonth           Int?
  expiryYear            Int?
  
  isDefault             Boolean  @default(false)
  status                PaymentMethodStatus @default(ACTIVE)
  
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  @@index([userId])
}

model ShipmentDocument {
  id                    String   @id @default(cuid())
  shipmentId            String
  shipment              Shipment @relation(fields: [shipmentId], references: [id], onDelete: Cascade)
  
  type                  DocumentType
  fileName              String
  fileUrl               String
  fileSize              Int
  mimeType              String
  
  uploadedAt            DateTime @default(now())

  @@index([shipmentId])
}

model ShipmentIssue {
  id                    String   @id @default(cuid())
  shipmentId            String
  shipment              Shipment @relation(fields: [shipmentId], references: [id], onDelete: Cascade)
  
  issueType             IssueType
  description           String
  status                IssueStatus @default(OPEN)
  resolution            String?
  
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  @@index([shipmentId])
  @@index([status])
}

model RefundRequest {
  id                    String   @id @default(cuid())
  shipmentId            String   @unique
  shipment              Shipment @relation(fields: [shipmentId], references: [id], onDelete: Cascade)
  
  reason                String
  amount                Float
  status                RefundStatus @default(PENDING)
  processedAt           DateTime?
  
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  @@index([status])
}

model Notification {
  id                    String   @id @default(cuid())
  userId                String
  user                  User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  shipmentId            String?
  shipment              Shipment? @relation(fields: [shipmentId], references: [id], onDelete: Cascade)
  
  type                  NotificationType
  title                 String
  message               String
  isRead                Boolean  @default(false)
  
  createdAt             DateTime @default(now())

  @@index([userId])
  @@index([isRead])
}

model DriverNotification {
  id                    String   @id @default(cuid())
  driverId              String
  driver                Driver   @relation(fields: [driverId], references: [id], onDelete: Cascade)
  
  type                  String
  title                 String
  message               String
  isRead                Boolean  @default(false)
  
  createdAt             DateTime @default(now())

  @@index([driverId])
  @@index([isRead])
}

model TrackingSubscription {
  id                    String   @id @default(cuid())
  userId                String
  user                  User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  shipmentId            String
  shipment              Shipment @relation(fields: [shipmentId], references: [id], onDelete: Cascade)
  
  subscribedAt          DateTime @default(now())

  @@unique([userId, shipmentId])
  @@index([userId])
}

model Payment {
  id                    String   @id @default(cuid())
  shipmentId            String   @unique
  shipment              Shipment @relation(fields: [shipmentId], references: [id], onDelete: Cascade)
  
  amount                Float
  currency              String   @default("USD")
  status                PaymentStatus
  stripePaymentIntentId String?  @unique
  
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  @@index([status])
}

// Enums
enum UserRole {
  CUSTOMER
  DRIVER
  ADMIN
  SUPER_ADMIN
}

enum UserStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
  DELETED
}

enum DriverStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
  DELETED
}

enum ShipmentStatus {
  PENDING
  PROCESSING
  ON_HOLD
  PICKED_UP
  IN_TRANSIT
  IN_CUSTOMS
  CUSTOMS_CLEARED
  ARRIVED_AT_FACILITY
  OUT_FOR_DELIVERY
  DELIVERY_ATTEMPTED
  DELIVERED
  RETURNED
  CANCELLED
}

enum TransportMode {
  AIR
  LAND
  WATER
  MULTIMODAL
}

enum ServiceType {
  EXPRESS
  STANDARD
  ECONOMY
}

enum PackageType {
  DOCUMENTS
  PARCEL
  FRAGILE
  ELECTRONICS
  CLOTHING
  FOOD
  HAZARDOUS
  OTHER
}

enum CustomsStatus {
  PENDING
  IN_REVIEW
  CLEARED
  REJECTED
  PENDING_PAYMENT
}

enum AddressType {
  HOME
  BUSINESS
  OTHER
}

enum PaymentType {
  CREDIT_CARD
  DEBIT_CARD
  BANK_TRANSFER
  WALLET
}

enum PaymentMethodStatus {
  ACTIVE
  EXPIRED
  SUSPENDED
}

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
  ACTIVE
  EXPIRED
  SUSPENDED
}

enum DocumentType {
  INVOICE
  CUSTOMS_FORM
  INSURANCE
  PROOF_OF_DELIVERY
  SIGNATURE
  PHOTO
  OTHER
}

enum IssueType {
  DELAYED
  DAMAGED
  LOST
  ADDRESS_ISSUE
  RECIPIENT_UNAVAILABLE
  OTHER
}

enum IssueStatus {
  OPEN
  IN_PROGRESS
  RESOLVED
  CLOSED
}

enum RefundStatus {
  PENDING
  APPROVED
  REJECTED
  PROCESSED
}

enum NotificationType {
  SHIPMENT_CREATED
  SHIPMENT_PICKED_UP
  SHIPMENT_IN_TRANSIT
  SHIPMENT_IN_CUSTOMS
  SHIPMENT_CUSTOMS_CLEARED
  SHIPMENT_OUT_FOR_DELIVERY
  SHIPMENT_DELIVERED
  SHIPMENT_RETURNED
  DELIVERY_ATTEMPTED
  DELIVERY_ISSUE
  ETA_UPDATED
  DRIVER_ASSIGNED
  STATUS_UPDATE
}
